<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>StationHelp — Lines & Stations (R/Y/G + Stop)</title>
<style>
  :root{
    --bg:#0b0c10; --panel:#121318; --ink:#e8eef2; --muted:#a9b3bd;
    --accent:#0050ef;           /* your blue */
    --border:#262933;
    --red:#ec0000;              /* your red */
    --yellow:#f2c94c;
    --green:#1db954;
    --stop:#7a7f89;
  }
  *{box-sizing:border-box}
  body{margin:0;font-family:ui-sans-serif,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:linear-gradient(180deg,#0b0c10,#0f1117 60%,#0b0c10);color:var(--ink)}
  .wrap{max-width:1200px;margin:36px auto;padding:0 16px}
  h1{margin:0 0 10px;font-size:28px;font-weight:800}
  .sub{color:var(--muted);margin-bottom:18px}
  .toolbar{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:16px}
  button{border:1px solid var(--border);background:#151824;color:var(--ink);padding:9px 12px;border-radius:12px;cursor:pointer;font-weight:600}
  button:hover{filter:brightness(1.12)}
  .primary{background:var(--accent);border-color:transparent}
  .ghost{background:transparent}
  .panel{background:var(--panel);border:1px solid var(--border);border-radius:16px;padding:14px;margin-bottom:14px}
  .line{margin-bottom:14px}
  .line header{display:flex;gap:10px;align-items:center;justify-content:space-between}
  .line-title{display:flex;gap:8px;align-items:center}
  .line-title input{background:#0f1117;border:1px solid var(--border);color:var(--ink);padding:8px 10px;border-radius:10px;min-width:220px}
  .stations{margin-top:10px}
  table{width:100%;border-collapse:collapse;border-radius:12px;overflow:hidden;border:1px solid var(--border)}
  th,td{padding:10px;border-bottom:1px solid var(--border);text-align:left;vertical-align:middle}
  th{background:#171922;color:#cfd6dd;font-weight:700;font-size:14px}
  td{background:#12141c;font-size:14px}
  tr:last-child td{border-bottom:0}
  input[type="text"].station{width:100%;background:#0f1117;border:1px solid var(--border);color:var(--ink);padding:7px 9px;border-radius:10px}
  .status-btns{display:flex;gap:6px;flex-wrap:wrap}
  .chip{border-radius:999px;border:1px solid var(--border);padding:7px 11px;font-weight:700;font-size:12px;background:#0f1117;cursor:pointer;display:inline-flex;align-items:center;gap:8px}
  .dot{width:10px;height:10px;border-radius:50%}
  .red{background:color-mix(in oklab, var(--red) 35%, #0f1117)}
  .yellow{background:color-mix(in oklab, var(--yellow) 35%, #0f1117)}
  .green{background:color-mix(in oklab, var(--green) 35%, #0f1117)}
  .stop{background:color-mix(in oklab, var(--stop) 35%, #0f1117)}
  .dot.red{background:var(--red)} .dot.yellow{background:var(--yellow)} .dot.green{background:var(--green)} .dot.stop{background:var(--stop)}
  .muted{color:var(--muted)}
  .right{text-align:right}
  .sm{font-size:12px;color:var(--muted)}
  .no-data{text-align:center;padding:18px;color:var(--muted)}
  @media (max-width: 800px){
    th:nth-child(3),td:nth-child(3){display:none} /* hide timestamp on small screens */
  }
</style>
</head>
<body>
<div class="wrap">
  <h1>StationHelp — Lines & Stations</h1>
  <div class="sub">Group stations by <b>Production Line</b>. Click <b>Red/Yellow/Green</b> to start a timer, or <b>Stop</b> to freeze it. Timestamps and elapsed are saved automatically.</div>

  <div class="toolbar">
    <button class="primary" id="addLineBtn">+ Add Line</button>
    <button id="exportBtn">Export CSV</button>
    <button class="ghost" id="resetBtn">Reset All</button>
    <span class="sm">Tip: rename lines and stations to match your floor. Data is stored in this browser.</span>
  </div>

  <div id="lines"></div>
</div>

<script>
(function(){
  const STORAGE_KEY = "stationhelp_lines_v1";

  /** Data model
   * lines: [
   *   { id, name, stations: [
   *      { id, label, status: 'red'|'yellow'|'green'|'stopped'|null,
   *        lastChange: ms|null,
   *        startedAt: ms|null,         // when current run started (if running)
   *        accumulated: number }        // ms accumulated from past runs (when stopped or before reset)
   *   ]}
   * ]
   */

  let lines = load() || seed();

  const $lines = document.getElementById("lines");
  document.getElementById("addLineBtn").addEventListener("click", () => {
    lines.push(newLine(`Line ${lines.length+1}`));
    save(); render();
  });
  document.getElementById("resetBtn").addEventListener("click", () => {
    if (!confirm("Reset ALL lines and stations? This clears local data.")) return;
    lines = seed(true); save(); render();
  });
  document.getElementById("exportBtn").addEventListener("click", () => exportCSV());

  function newLine(name="Line"){
    return { id: uuid(), name, stations: [ newStation("Station 1"), newStation("Station 2") ] };
  }
  function newStation(label="Station"){
    return { id: uuid(), label, status: null, lastChange: null, startedAt: null, accumulated: 0 };
  }
  function uuid(){ return crypto.randomUUID(); }

  function seed(blank=false){
    if (blank) return [];
    return [
      { id: uuid(), name: "Line A", stations: [ newStation("Station 1"), newStation("Station 2") ] },
      { id: uuid(), name: "Line B", stations: [ newStation("Station 3") ] }
    ];
  }

  function load(){
    try { return JSON.parse(localStorage.getItem(STORAGE_KEY)); } catch { return null; }
  }
  function save(){
    localStorage.setItem(STORAGE_KEY, JSON.stringify(lines));
  }

  function fmtDate(ms){
    if(!ms) return "—";
    return new Date(ms).toLocaleString();
  }
  function fmtElapsed(ms){
    if(ms==null) return "—";
    const s = Math.floor(ms/1000);
    const hh = String(Math.floor(s/3600)).padStart(2,"0");
    const mm = String(Math.floor((s%3600)/60)).padStart(2,"0");
    const ss = String(s%60).padStart(2,"0");
    return `${hh}:${mm}:${ss}`;
  }
  function runningElapsed(st){ // live or frozen
    if(st.startedAt){ return st.accumulated + (Date.now() - st.startedAt); }
    return st.accumulated;
  }

  function setStatus(station, color){ // red|yellow|green
    const now = Date.now();
    // start fresh timer when color changes
    station.status = color;
    station.lastChange = now;
    station.startedAt = now;
    station.accumulated = 0;
    save(); // render tick will update UI
  }
  function stopStation(station){
    const now = Date.now();
    if (station.startedAt){ station.accumulated += (now - station.startedAt); }
    station.startedAt = null;
    station.status = "stopped";
    station.lastChange = now;
    save();
  }
  function removeStation(line, stationId){
    line.stations = line.stations.filter(s => s.id !== stationId);
    save(); render();
  }
  function addStation(line){
    line.stations.push(newStation(`Station ${line.stations.length+1}`));
    save(); render();
  }
  function removeLine(lineId){
    if (!confirm("Delete this line and its stations?")) return;
    lines = lines.filter(l => l.id !== lineId);
    save(); render();
  }

  function render(){
    $lines.innerHTML = "";
    if (lines.length === 0){
      const empty = document.createElement("div");
      empty.className = "panel no-data";
      empty.textContent = "No lines yet. Click + Add Line to begin.";
      $lines.appendChild(empty);
      return;
    }

    lines.forEach(line => {
      const card = document.createElement("div");
      card.className = "panel line";

      // header
      const header = document.createElement("header");
      const left = document.createElement("div");
      left.className = "line-title";
      const nameInput = document.createElement("input");
      nameInput.value = line.name;
      nameInput.addEventListener("input", () => { line.name = nameInput.value; save(); });
      const addBtn = document.createElement("button");
      addBtn.textContent = "+ Add Station";
      addBtn.className = "primary";
      addBtn.addEventListener("click", () => addStation(line));
      left.append(nameInput, addBtn);

      const right = document.createElement("div");
      const delLine = document.createElement("button");
      delLine.className = "ghost";
      delLine.textContent = "Delete Line";
      delLine.addEventListener("click", () => removeLine(line.id));
      right.appendChild(delLine);

      header.append(left, right);
      card.appendChild(header);

      // table
      const table = document.createElement("table");
      table.innerHTML = `
        <thead>
          <tr>
            <th style="width:34%">Station</th>
            <th style="width:34%">Status</th>
            <th style="width:16%">Last Change</th>
            <th style="width:16%">Elapsed</th>
          </tr>
        </thead>
        <tbody></tbody>
      `;
      const tbody = table.querySelector("tbody");

      line.stations.forEach(st => {
        const tr = document.createElement("tr");

        // Station name
        const tdName = document.createElement("td");
        const inStation = document.createElement("input");
        inStation.className = "station";
        inStation.value = st.label;
        inStation.placeholder = "Station name…";
        inStation.addEventListener("input", () => { st.label = inStation.value; save(); });
        tdName.appendChild(inStation);

        // Status chips
        const tdStatus = document.createElement("td");
        const wrap = document.createElement("div");
        wrap.className = "status-btns";

        [
          {k:"red",    label:"RED",    cls:"chip red",    dot:"red"},
          {k:"yellow", label:"YELLOW", cls:"chip yellow", dot:"yellow"},
          {k:"green",  label:"GREEN",  cls:"chip green",  dot:"green"},
          {k:"stopped",label:"STOP",   cls:"chip stop",   dot:"stop"},
        ].forEach(opt=>{
          const b = document.createElement("button");
          b.className = opt.cls;
          b.innerHTML = `<span class="dot ${opt.dot}"></span> ${opt.label}`;
          b.addEventListener("click", ()=>{
            if (opt.k === "stopped"){ stopStation(st); updateRow(tr, st); }
            else { setStatus(st, opt.k); updateRow(tr, st); }
          });
          wrap.appendChild(b);
        });

        // quick delete
        const del = document.createElement("button");
        del.className = "ghost";
        del.textContent = "Delete";
        del.addEventListener("click", ()=> removeStation(line, st.id));
        wrap.appendChild(del);

        tdStatus.appendChild(wrap);

        // Timestamp
        const tdStamp = document.createElement("td");
        tdStamp.dataset.kind = "stamp";
        tdStamp.textContent = fmtDate(st.lastChange);

        // Elapsed
        const tdElapsed = document.createElement("td");
        tdElapsed.dataset.kind = "elapsed";
        tdElapsed.textContent = st.lastChange ? fmtElapsed(runningElapsed(st)) : "—";

        tr.append(tdName, tdStatus, tdStamp, tdElapsed);
        tbody.appendChild(tr);
      });

      card.appendChild(table);
      $lines.appendChild(card);
    });
  }

  function updateRow(tr, st){
    tr.querySelector('td[data-kind="stamp"]').textContent = fmtDate(st.lastChange);
    tr.querySelector('td[data-kind="elapsed"]').textContent =
      st.lastChange ? fmtElapsed(runningElapsed(st)) : "—";
  }

  // 1s tick for all running stations
  setInterval(()=>{
    // update all elapsed cells without re-rendering everything
    const cards = $lines.querySelectorAll(".line");
    let cardIdx = 0;
    lines.forEach(line=>{
      const tbody = cards[cardIdx]?.querySelector("tbody");
      if (!tbody){ cardIdx++; return; }
      const trs = [...tbody.querySelectorAll("tr")];
      line.stations.forEach((st, i)=>{
        const tdElapsed = trs[i]?.querySelector('td[data-kind="elapsed"]');
        if (tdElapsed){
          tdElapsed.textContent = st.lastChange ? fmtElapsed(runningElapsed(st)) : "—";
        }
      });
      cardIdx++;
    });
  }, 1000);

  // CSV export (Lines & Stations)
  function exportCSV(){
    const header = ["Line","Station","Status","Last Change","Elapsed (hh:mm:ss)"];
    const rows = [header.join(",")];
    lines.forEach(line=>{
      line.stations.forEach(st=>{
        rows.push([
          csv(line.name),
          csv(st.label),
          csv(st.status || ""),
          csv(fmtDate(st.lastChange)),
          csv(st.lastChange ? fmtElapsed(runningElapsed(st)) : "—"),
        ].join(","));
      });
    });
    const blob = new Blob([rows.join("\n")], {type:"text/csv"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url; a.download = "stationhelp.csv"; a.click();
    URL.revokeObjectURL(url);
  }
  function csv(s){
    const t=(s??"").toString();
    return /[,"\n]/.test(t) ? `"${t.replace(/"/g,'""')}"` : t;
  }

  // init
  render();

})();
</script>
</body>
</html>
