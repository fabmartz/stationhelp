<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>StationHelp — Lines, Stations, Colors & Timers</title>
<style>
  :root{
    --bg:#0b0c10; --panel:#121318; --ink:#e8eef2; --muted:#a9b3bd;
    --accent:#0050ef;            /* your blue */
    --border:#262933;
    --red:#ec0000;               /* your red */
    --yellow:#f2c94c;
    --green:#1db954;
    --reset:#7a7f89;
  }
  *{box-sizing:border-box}
  body{margin:0;font-family:ui-sans-serif,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:#0f1117;color:var(--ink)}
  .wrap{max-width:1200px;margin:36px auto;padding:0 16px}
  h1{margin:0 0 10px;font-size:28px;font-weight:800}
  .sub{color:var(--muted);margin-bottom:18px}
  .toolbar{display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin-bottom:16px}
  .toolbar .right{margin-left:auto;display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  button{border:1px solid var(--border);background:#151824;color:var(--ink);padding:9px 12px;border-radius:12px;font-weight:600;cursor:pointer}
  button:hover{filter:brightness(1.12)}
  .primary{background:var(--accent);border-color:transparent}
  .ghost{background:transparent}
  .panel{background:var(--panel);border:1px solid var(--border);border-radius:16px;padding:14px;margin-bottom:14px}
  .line{margin-bottom:14px}
  .line header{display:flex;gap:10px;align-items:center;justify-content:space-between}
  .line-title{display:flex;gap:8px;align-items:center}
  .line-title input{background:#0f1117;border:1px solid var(--border);color:var(--ink);padding:8px 10px;border-radius:10px;min-width:220px}
  table{width:100%;border-collapse:collapse;border-radius:12px;overflow:hidden;border:1px solid var(--border)}
  th,td{padding:10px;border-bottom:1px solid var(--border);text-align:left;vertical-align:middle}
  th{background:#171922;color:#cfd6dd;font-weight:700;font-size:14px}
  td{background:#12141c;font-size:14px}
  tr:last-child td{border-bottom:0}
  input[type="text"].station{width:100%;background:#0f1117;border:1px solid var(--border);color:var(--ink);padding:7px 9px;border-radius:10px}
  .status-btns{display:flex;gap:6px;flex-wrap:wrap}
  .chip{border-radius:999px;border:1px solid var(--border);padding:7px 11px;font-weight:700;font-size:12px;background:#0f1117;cursor:pointer;display:inline-flex;align-items:center;gap:8px}
  .dot{width:10px;height:10px;border-radius:50%}
  .chip.red{background:#1a0d0d} .chip.yellow{background:#1a190d} .chip.green{background:#0d1a12} .chip.reset{background:#14161a}
  .dot.red{background:var(--red)} .dot.yellow{background:var(--yellow)} .dot.green{background:var(--green)} .dot.reset{background:var(--reset)}
  .no-data{text-align:center;padding:18px;color:var(--muted)}
  @media (max-width: 800px){
    th:nth-child(3),td:nth-child(3){display:none}
  }
</style>
</head>
<body>
<div class="wrap">
  <h1>StationHelp — Lines & Stations</h1>
  <div class="sub">Associates select <b>Red / Yellow / Green</b> to signal. <b>Problem Solved / Reset</b> clears the timer.</div>

  <div class="toolbar">
    <button class="primary" id="addLineBtn">+ Add Line</button>
    <button id="exportBtn">Export CSV</button>
    <button class="ghost" id="resetBtn">Reset All</button>
  </div>

  <div id="lines"></div>
</div>

<script>
(function(){
  // UUID polyfill
  if(!crypto.randomUUID){
    crypto.randomUUID=function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(c){var r=Math.random()*16|0,v=c=="x"?r:(r&0x3|0x8);return v.toString(16)})};
  }

  const STORAGE_KEY="stationhelp_lines_v3";
  function saveData(obj){localStorage.setItem(STORAGE_KEY,JSON.stringify(obj));}
  function loadData(){try{return JSON.parse(localStorage.getItem(STORAGE_KEY))}catch(e){return null}}

  let lines=loadData()||[newLine("Line A")];
  const $lines=document.getElementById("lines");

  document.getElementById("addLineBtn").addEventListener("click",()=>{lines.push(newLine(`Line ${lines.length+1}`));persist();render();});
  document.getElementById("resetBtn").addEventListener("click",()=>{if(confirm("Clear all data?")){lines=[newLine("Line A")];persist();render();}});
  document.getElementById("exportBtn").addEventListener("click",exportCSV);

  function newLine(name){return{id:crypto.randomUUID(),name,stations:[newStation("Station 1"),newStation("Station 2")]};}
  function newStation(label){return{id:crypto.randomUUID(),label,status:null,lastChange:null,startedAt:null,accumulated:0};}
  function persist(){saveData(lines);}

  function fmtDate(ms){return ms?new Date(ms).toLocaleString():"—";}
  function fmtElapsed(ms){if(ms==null)return"—";const s=Math.floor(ms/1000);const h=String(Math.floor(s/3600)).padStart(2,"0");const m=String(Math.floor((s%3600)/60)).padStart(2,"0");const ss=String(s%60).padStart(2,"0");return`${h}:${m}:${ss}`;}
  function runningElapsed(st){return st.startedAt?st.accumulated+(Date.now()-st.startedAt):st.accumulated;}

  function setStatus(st,color){const now=Date.now();st.status=color;st.lastChange=now;st.startedAt=now;st.accumulated=0;persist();}
  function resetStation(st){st.status=null;st.lastChange=Date.now();st.startedAt=null;st.accumulated=0;persist();}

  function addStation(line){line.stations.push(newStation(`Station ${line.stations.length+1}`));persist();render();}
  function removeStation(line,id){line.stations=line.stations.filter(s=>s.id!==id);persist();render();}
  function removeLine(id){if(!confirm("Delete this line?"))return;lines=lines.filter(l=>l.id!==id);persist();render();}

  function render(){
    $lines.innerHTML="";
    lines.forEach(line=>{
      const card=document.createElement("div");card.className="panel line";

      const header=document.createElement("header");
      const left=document.createElement("div");left.className="line-title";
      const nameInput=document.createElement("input");nameInput.value=line.name;nameInput.addEventListener("input",()=>{line.name=nameInput.value;persist();});
      const addBtn=document.createElement("button");addBtn.textContent="+ Add Station";addBtn.className="primary";addBtn.addEventListener("click",()=>addStation(line));
      left.append(nameInput,addBtn);

      const right=document.createElement("div");
      const delLine=document.createElement("button");delLine.className="ghost";delLine.textContent="Delete Line";delLine.addEventListener("click",()=>removeLine(line.id));
      right.appendChild(delLine);

      header.append(left,right);card.appendChild(header);

      const table=document.createElement("table");
      table.innerHTML=`<thead><tr><th style="width:34%">Station</th><th style="width:34%">Status</th><th style="width:16%">Last Change</th><th style="width:16%">Elapsed</th></tr></thead><tbody></tbody>`;
      const tbody=table.querySelector("tbody");

      line.stations.forEach(st=>{
        const tr=document.createElement("tr");

        const tdName=document.createElement("td");
        const inStation=document.createElement("input");inStation.className="station";inStation.value=st.label;
        inStation.addEventListener("input",()=>{st.label=inStation.value;persist();});
        tdName.appendChild(inStation);

        const tdStatus=document.createElement("td");
        const wrap=document.createElement("div");wrap.className="status-btns";
        [
          {k:"red",lbl:"RED",cls:"chip red",dot:"red"},
          {k:"yellow",lbl:"YELLOW",cls:"chip yellow",dot:"yellow"},
          {k:"green",lbl:"GREEN",cls:"chip green",dot:"green"},
          {k:"reset",lbl:"RESET",cls:"chip reset",dot:"reset"}
        ].forEach(o=>{
          const b=document.createElement("button");b.className=o.cls;b.innerHTML=`<span class="dot ${o.dot}"></span> ${o.lbl}`;
          b.addEventListener("click",()=>{o.k==="reset"?resetStation(st):setStatus(st,o.k);updateRow(tr,st);});
          wrap.appendChild(b);
        });
        const del=document.createElement("button");del.className="ghost";del.textContent="Delete";del.addEventListener("click",()=>removeStation(line,st.id));
        wrap.appendChild(del);
        tdStatus.appendChild(wrap);

        const tdStamp=document.createElement("td");tdStamp.dataset.kind="stamp";tdStamp.textContent=fmtDate(st.lastChange);
        const tdElapsed=document.createElement("td");tdElapsed.dataset.kind="elapsed";tdElapsed.textContent=st.lastChange?fmtElapsed(runningElapsed(st)):"—";

        tr.append(tdName,tdStatus,tdStamp,tdElapsed);
        tbody.appendChild(tr);
      });

      card.appendChild(table);$lines.appendChild(card);
    });
  }

  function updateRow(tr,st){
    const stamp=tr.querySelector('td[data-kind="stamp"]');
    const elapsed=tr.querySelector('td[data-kind="elapsed"]');
    if(stamp)stamp.textContent=fmtDate(st.lastChange);
    if(elapsed)elapsed.textContent=st.lastChange?fmtElapsed(runningElapsed(st)):"—";
  }

  setInterval(()=>{
    const cards=$lines.querySelectorAll(".line");let ci=0;
    lines.forEach(line=>{
      const tbody=cards[ci]?.querySelector("tbody");if(!tbody){ci++;return;}
      const trs=[...tbody.querySelectorAll("tr")];
      line.stations.forEach((st,i)=>{
        const tdElapsed=trs[i]?.querySelector('td[data-kind="elapsed"]');
        if(tdElapsed)tdElapsed.textContent=st.lastChange?fmtElapsed(runningElapsed(st)):"—";
      });
      ci++;
    });
  },1000);

  function exportCSV(){
    const header=["Line","Station","Status","Last Change","Elapsed"];
    const rows=[header.join(",")];
    lines.forEach(line=>{
      line.stations.forEach(st=>{
        rows.push([csv(line.name),csv(st.label),csv(st.status||""),csv(fmtDate(st.lastChange)),csv(fmtElapsed(runningElapsed(st)))].join(","));
      });
    });
    const blob=new Blob([rows.join("\n")],{type:"text/csv"});
    const url=URL.createObjectURL(blob);
    const a=document.createElement("a");a.href=url;a.download="stationhelp.csv";a.click();URL.revokeObjectURL(url);
  }
  function csv(s){const t=(s??"").toString();return/[,"\n]/.test(t)?`"${t.replace(/"/g,'""')}"`:t;}

  render();
})();
</script>
</body>
</html>
